<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .config-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üî• Firebase Connection Test</h1>
    <p>Use this page to verify your Firebase configuration is working correctly.</p>

    <div class="test-card">
        <h3>Step 1: Update Firebase Configuration</h3>
        <p>Replace the configuration below with your actual Firebase project details:</p>
        <div class="config-display" id="configDisplay">
// Replace this configuration with your actual Firebase config:
const firebaseConfig = {
    apiKey: "your-api-key-here",
    authDomain: "your-project.firebaseapp.com",
    projectId: "your-project-id",
    storageBucket: "your-project.appspot.com",
    messagingSenderId: "123456789",
    appId: "your-app-id"
};
        </div>
    </div>

    <div class="test-card">
        <h3>Step 2: Test Firebase Connection</h3>
        <button onclick="testFirebaseConnection()">Test Firebase Connection</button>
        <button onclick="testFirestoreWrite()">Test Firestore Write</button>
        <button onclick="testFirestoreRead()">Test Firestore Read</button>
        <div id="connectionStatus"></div>
    </div>

    <div class="test-card">
        <h3>Step 3: Test Sample Data</h3>
        <button onclick="addSampleData()">Add Sample Winder Data</button>
        <button onclick="readSampleData()">Read Sample Data</button>
        <div id="dataStatus"></div>
    </div>

    <div class="test-card">
        <h3>Step 4: Real-time Listener Test</h3>
        <button onclick="startRealtimeListener()">Start Real-time Listener</button>
        <button onclick="stopRealtimeListener()">Stop Listener</button>
        <div id="realtimeStatus"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Your actual Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBddHvEKKYdIcc5IkA0Ut4PFiTg_y-I2ts",
            authDomain: "winderlogbook.firebaseapp.com",
            projectId: "winderlogbook",
            storageBucket: "winderlogbook.firebasestorage.app",
            messagingSenderId: "43168247130",
            appId: "1:43168247130:web:abf0674e0a112c6552d763",
            measurementId: "G-LRJ8Y3L6VL"
        };

        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js';

        let app, db, unsubscribe;

        // Test Firebase connection
        window.testFirebaseConnection = async function() {
            const statusDiv = document.getElementById('connectionStatus');
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                statusDiv.innerHTML = '<div class="status success">‚úÖ Firebase connected successfully!</div>';
                console.log('Firebase initialized:', app);
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Firebase connection failed: ${error.message}</div>`;
                console.error('Firebase error:', error);
            }
        };

        // Test Firestore write
        window.testFirestoreWrite = async function() {
            const statusDiv = document.getElementById('connectionStatus');
            if (!db) {
                statusDiv.innerHTML = '<div class="status error">‚ùå Please test Firebase connection first</div>';
                return;
            }

            try {
                const testDoc = {
                    test: true,
                    message: 'Hello from Winder Logbook test!',
                    timestamp: new Date().toISOString(),
                    created: Date.now()
                };

                const docRef = await addDoc(collection(db, 'test_collection'), testDoc);
                statusDiv.innerHTML += `<div class="status success">‚úÖ Firestore write successful! Document ID: ${docRef.id}</div>`;
            } catch (error) {
                statusDiv.innerHTML += `<div class="status error">‚ùå Firestore write failed: ${error.message}</div>`;
                console.error('Firestore write error:', error);
            }
        };

        // Test Firestore read
        window.testFirestoreRead = async function() {
            const statusDiv = document.getElementById('connectionStatus');
            if (!db) {
                statusDiv.innerHTML = '<div class="status error">‚ùå Please test Firebase connection first</div>';
                return;
            }

            try {
                const querySnapshot = await getDocs(collection(db, 'test_collection'));
                const docCount = querySnapshot.size;
                statusDiv.innerHTML += `<div class="status success">‚úÖ Firestore read successful! Found ${docCount} documents</div>`;
                
                querySnapshot.forEach((doc) => {
                    console.log('Document data:', doc.id, doc.data());
                });
            } catch (error) {
                statusDiv.innerHTML += `<div class="status error">‚ùå Firestore read failed: ${error.message}</div>`;
                console.error('Firestore read error:', error);
            }
        };

        // Add sample winder data
        window.addSampleData = async function() {
            const statusDiv = document.getElementById('dataStatus');
            if (!db) {
                statusDiv.innerHTML = '<div class="status error">‚ùå Please test Firebase connection first</div>';
                return;
            }

            try {
                // Sample trip counter data
                const tripData = {
                    entryType: 'trip_counters',
                    date: new Date().toISOString().split('T')[0],
                    shift: 'Morning',
                    user: 'Bays Draganovic',
                    counters: {
                        persons: 15,
                        material: 8,
                        mineral: 5,
                        explosives: 2
                    },
                    timestamp: Date.now()
                };

                // Sample component status
                const componentData = {
                    entryType: 'component_status',
                    component: 'Engine',
                    status: 'good',
                    user: 'Bays Draganovic',
                    shift: 'Morning',
                    timestamp: Date.now(),
                    date: new Date().toISOString().split('T')[0]
                };

                await addDoc(collection(db, 'trip_counters'), tripData);
                await addDoc(collection(db, 'component_status'), componentData);

                statusDiv.innerHTML = '<div class="status success">‚úÖ Sample winder data added successfully!</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Failed to add sample data: ${error.message}</div>`;
                console.error('Sample data error:', error);
            }
        };

        // Read sample data
        window.readSampleData = async function() {
            const statusDiv = document.getElementById('dataStatus');
            if (!db) {
                statusDiv.innerHTML = '<div class="status error">‚ùå Please test Firebase connection first</div>';
                return;
            }

            try {
                const tripSnapshot = await getDocs(collection(db, 'trip_counters'));
                const componentSnapshot = await getDocs(collection(db, 'component_status'));

                let output = `<div class="status success">‚úÖ Found ${tripSnapshot.size} trip records and ${componentSnapshot.size} component records</div>`;
                
                if (tripSnapshot.size > 0) {
                    output += '<div class="status info">Latest Trip Data:</div>';
                    tripSnapshot.forEach((doc) => {
                        const data = doc.data();
                        output += `<div style="margin-left: 20px;">‚Ä¢ ${data.shift} shift: ${JSON.stringify(data.counters)}</div>`;
                    });
                }

                statusDiv.innerHTML = output;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Failed to read sample data: ${error.message}</div>`;
                console.error('Read sample data error:', error);
            }
        };

        // Start real-time listener
        window.startRealtimeListener = function() {
            const statusDiv = document.getElementById('realtimeStatus');
            if (!db) {
                statusDiv.innerHTML = '<div class="status error">‚ùå Please test Firebase connection first</div>';
                return;
            }

            try {
                const q = query(collection(db, 'trip_counters'), orderBy('timestamp', 'desc'), limit(5));
                
                unsubscribe = onSnapshot(q, (snapshot) => {
                    statusDiv.innerHTML = `<div class="status success">‚úÖ Real-time listener active! Monitoring ${snapshot.size} documents</div>`;
                    
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            statusDiv.innerHTML += `<div class="status info">üìä New trip data detected: ${JSON.stringify(change.doc.data().counters)}</div>`;
                        }
                    });
                });

                statusDiv.innerHTML = '<div class="status info">üîÑ Starting real-time listener...</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Real-time listener failed: ${error.message}</div>`;
                console.error('Real-time listener error:', error);
            }
        };

        // Stop real-time listener
        window.stopRealtimeListener = function() {
            const statusDiv = document.getElementById('realtimeStatus');
            if (unsubscribe) {
                unsubscribe();
                statusDiv.innerHTML = '<div class="status info">‚èπÔ∏è Real-time listener stopped</div>';
            } else {
                statusDiv.innerHTML = '<div class="status error">‚ùå No active listener to stop</div>';
            }
        };

        // Auto-update config display
        document.getElementById('configDisplay').textContent = `// Replace this configuration with your actual Firebase config:
const firebaseConfig = {
    apiKey: "${firebaseConfig.apiKey}",
    authDomain: "${firebaseConfig.authDomain}",
    projectId: "${firebaseConfig.projectId}",
    storageBucket: "${firebaseConfig.storageBucket}",
    messagingSenderId: "${firebaseConfig.messagingSenderId}",
    appId: "${firebaseConfig.appId}"
};`;
    </script>
</body>
</html>
